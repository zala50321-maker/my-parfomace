<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zala Manish Performance Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#3B82F6',
                        'success-green': '#10B981',
                        'alert-red': '#EF4444',
                        'background-light': '#F9FAFB',
                    },
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f7f9fb;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s;
        }
        .tracker-card {
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .rating-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.15s ease-in-out;
        }
        .rating-btn.selected {
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- New Animation for Title --- */
        @keyframes glowing {
            0% { text-shadow: 0 0 5px #3B82F6; }
            50% { text-shadow: 0 0 15px #3B82F6, 0 0 20px #60A5FA; }
            100% { text-shadow: 0 0 5px #3B82F6; }
        }
        .animated-title {
            animation: glowing 2s infinite alternate;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="app" class="w-full max-w-4xl mt-6 space-y-8">
        <!-- Header: User Name and Title (Updated with animation) -->
        <header class="text-center">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-1 animated-title">Zala Manish Performance Tracker üåü</h1>
            <p class="text-xl font-medium text-primary-blue">‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü‡§§‡§æ ‡§ï‡•Ä ‡§ì‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡§æ‡§∞‡•ç‡§ó!</p>
        </header>

        <!-- Daily Tracker Card -->
        <section id="dailyTracker" class="tracker-card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                ‡§Ü‡§ú ‡§ï‡§æ ‡§ö‡•á‡§ï-‡§á‡§®: <span id="currentDateDisplay" class="ml-2 text-primary-blue font-semibold"></span>
            </h2>

            <div class="space-y-6">
                <!-- 1. Exercise (Checkbox) -->
                <div class="p-4 border-2 border-primary-blue/30 rounded-xl flex items-center justify-between transition duration-300 hover:shadow-lg">
                    <label for="exerciseCheck" class="text-lg font-medium text-gray-700">1. ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§®‡•á ‡§Ü‡§ú Exercise ‡§ï‡•Ä? (‡§π‡§æ‡§Å/‡§®‡§π‡•Ä‡§Ç)</label>
                    <input type="checkbox" id="exerciseCheck" class="form-checkbox h-6 w-6 text-primary-blue rounded border-primary-blue/50 focus:ring-primary-blue">
                </div>

                <!-- 2. Study Time (Input Hours) -->
                <div class="p-4 border-2 border-primary-blue/30 rounded-xl flex items-center justify-between transition duration-300 hover:shadow-lg">
                    <label for="studyHoursInput" class="text-lg font-medium text-gray-700">2. ‡§Ü‡§™‡§®‡•á ‡§ï‡§ø‡§§‡§®‡•á ‡§ò‡§Ç‡§ü‡•á ‡§™‡§¢‡§º‡§æ‡§à ‡§ï‡•Ä? (‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø: 2+ ‡§ò‡§Ç‡§ü‡•á)</label>
                    <input type="number" id="studyHoursInput" min="0" step="0.5" value="0" placeholder="‡§ò‡§Ç‡§ü‡•á"
                           class="w-24 p-2 border border-gray-300 rounded-lg text-center focus:border-primary-blue focus:ring-primary-blue">
                </div>

                <!-- 3. Nutrition Rating (5-point) -->
                <div class="p-4 border-2 border-primary-blue/30 rounded-xl transition duration-300 hover:shadow-lg">
                    <p class="text-lg font-medium text-gray-700 mb-3">3. ‡§Ü‡§ú ‡§ï‡§æ ‡§ñ‡§æ‡§®-‡§™‡§æ‡§® ‡§™‡•ã‡§∑‡§£ (Nutrition) ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•à‡§∏‡§æ ‡§•‡§æ? (1 = ‡•ô‡§∞‡§æ‡§¨, 5 = ‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü)</p>
                    <div id="nutritionRatingContainer" class="flex justify-between max-w-sm mx-auto">
                        <button class="rating-btn bg-alert-red/80 hover:bg-alert-red text-white rounded-full" data-rating="1">1</button>
                        <button class="rating-btn bg-yellow-400/80 hover:bg-yellow-500 text-white rounded-full" data-rating="2">2</button>
                        <button class="rating-btn bg-yellow-300/80 hover:bg-yellow-400 text-gray-800 rounded-full" data-rating="3">3</button>
                        <button class="rating-btn bg-success-green/70 hover:bg-success-green/90 text-white rounded-full" data-rating="4">4</button>
                        <button class="rating-btn bg-success-green hover:bg-success-green/80 text-white rounded-full" data-rating="5">5</button>
                    </div>
                </div>

                <!-- Save Button and Status -->
                <div class="flex flex-col sm:flex-row items-center justify-between pt-4">
                    <button id="saveDayBtn" class="bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition duration-300 disabled:opacity-50">
                        ‡§Ü‡§ú ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç (Save)
                    </button>
                    <p id="saveStatus" class="mt-4 sm:mt-0 text-gray-600 font-medium"></p>
                </div>
            </div>
        </section>

        <!-- Daily Performance Report (Green/Red Alert) -->
        <section id="dailyReportSection" class="tracker-card hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (Daily Report)</h2>
            <div id="dailyReportContent" class="p-4 rounded-xl text-center transition duration-300 transform hover:scale-[1.01]">
                <!-- Daily feedback will appear here -->
            </div>
            <p id="studyHoursSummary" class="text-sm mt-3 text-gray-600 text-center"></p>
        </section>

        <!-- Monthly Report Section -->
        <section id="monthlyReportSection" class="tracker-card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§î‡§∞ ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (Monthly Report)</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p class="text-lg font-semibold text-gray-700">‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§ø‡§è ‡§ó‡§è ‡§¶‡§ø‡§®</p>
                    <p id="daysTrackedCount" class="text-3xl font-extrabold text-primary-blue">0</p>
                </div>
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p class="text-lg font-semibold text-gray-700">‡§ï‡•Å‡§≤ ‡§™‡§¢‡§º‡§æ‡§à ‡§ï‡•á ‡§ò‡§Ç‡§ü‡•á</p>
                    <p id="totalStudyHours" class="text-3xl font-extrabold text-success-green">0</p>
                </div>
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p class="text-lg font-semibold text-gray-700">‡§ï‡§Æ ‡§™‡•ã‡§∑‡§£ ‡§µ‡§æ‡§≤‡•á ‡§¶‡§ø‡§® (‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó 1-2)</p>
                    <p id="lowNutritionDays" class="text-3xl font-extrabold text-alert-red">0</p>
                </div>
            </div>

            <button id="generateMonthlyReportBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-full shadow-lg transition duration-300 disabled:opacity-50 flex items-center justify-center">
                <span id="reportBtnText">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</span>
                <span id="reportSpinner" class="spinner ml-3 hidden"></span>
            </button>

            <div id="monthlyReportContent" class="mt-6 p-6 border-2 border-yellow-300 rounded-xl bg-yellow-50 hidden">
                <h3 class="text-xl font-bold mb-3 text-gray-800">Zala Manish, ‡§Ø‡§π ‡§∞‡§π‡•Ä ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü:</h3>
                <div id="reportText" class="text-gray-700 space-y-3">
                    <!-- LLM generated report goes here -->
                </div>
                <div id="reportSources" class="mt-4 text-xs text-gray-500 hidden">
                    <p class="font-semibold mt-2">Grounding Sources:</p>
                    <ul id="reportSourceList" class="list-disc pl-5 space-y-1"></ul>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug'); // Enable debug logging for Firestore

        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, isAuthReady = false;
        let todayData = null; // Stores today's data from snapshot

        // --- DOM Elements ---
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const exerciseCheck = document.getElementById('exerciseCheck');
        const studyHoursInput = document.getElementById('studyHoursInput');
        const nutritionRatingContainer = document.getElementById('nutritionRatingContainer');
        const saveDayBtn = document.getElementById('saveDayBtn');
        const saveStatus = document.getElementById('saveStatus');
        const dailyReportSection = document.getElementById('dailyReportSection');
        const dailyReportContent = document.getElementById('dailyReportContent');
        const studyHoursSummary = document.getElementById('studyHoursSummary');
        const generateMonthlyReportBtn = document.getElementById('generateMonthlyReportBtn');
        const monthlyReportContent = document.getElementById('monthlyReportContent');
        const reportText = document.getElementById('reportText');
        const reportSources = document.getElementById('reportSources');
        const reportSourceList = document.getElementById('reportSourceList');
        const reportBtnText = document.getElementById('reportBtnText');
        const reportSpinner = document.getElementById('reportSpinner');

        // Monthly Summary Elements
        const daysTrackedCount = document.getElementById('daysTrackedCount');
        const totalStudyHours = document.getElementById('totalStudyHours');
        const lowNutritionDays = document.getElementById('lowNutritionDays');

        // --- Utility Functions ---
        function getTodayDateString() {
            const today = new Date();
            // Format: YYYY-MM-DD
            return today.getFullYear() + '-' +
                   String(today.getMonth() + 1).padStart(2, '0') + '-' +
                   String(today.getDate()).padStart(2, '0');
        }

        function getCollectionPath(uid) {
            return `artifacts/${appId}/users/${uid}/monthly_tracker`;
        }

        // --- Firebase Initialization and Auth ---
        document.addEventListener('DOMContentLoaded', async () => {
            currentDateDisplay.textContent = getTodayDateString();

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        setupDataListeners();
                        updateUIForToday(todayData); // Initial UI update

                    } else {
                        // Attempt to sign in
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                saveStatus.textContent = "Error: ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§";
                saveStatus.style.color = 'red';
            }
        });

        // --- Data Listeners and Handlers ---
        function setupDataListeners() {
            if (!isAuthReady || !userId || !db) return;

            const trackerRef = collection(db, getCollectionPath(userId));
            const q = query(trackerRef); // Query to fetch all documents

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                const allDaysData = [];
                snapshot.forEach(doc => {
                    allDaysData.push(doc.data());
                });

                // Find today's data
                const todayStr = getTodayDateString();
                todayData = allDaysData.find(d => d.date === todayStr);

                // Update UI based on today's data
                updateUIForToday(todayData);

                // Update Monthly Summary
                updateMonthlySummary(allDaysData);

            }, (error) => {
                console.error("Error setting up snapshot listener:", error);
                saveStatus.textContent = "Error: ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡•§";
                saveStatus.style.color = 'red';
            });
        }

        function updateUIForToday(data) {
            const todayStr = getTodayDateString();
            saveDayBtn.disabled = false;

            if (data) {
                exerciseCheck.checked = data.exercise;
                studyHoursInput.value = data.studyHours;
                updateRatingButtons(data.nutritionRating);

                saveStatus.textContent = `‚úÖ ‡§Ü‡§ú (${todayStr}) ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`;
                saveStatus.style.color = 'green';
                saveDayBtn.textContent = '‡§Ü‡§ú ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç';

                // Display Daily Report
                displayDailyReport(data);

            } else {
                exerciseCheck.checked = false;
                studyHoursInput.value = 0;
                updateRatingButtons(0);
                saveStatus.textContent = `‡§Ü‡§ú (${todayStr}) ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`;
                saveStatus.style.color = 'orange';
                saveDayBtn.textContent = '‡§Ü‡§ú ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç (Save)';
                dailyReportSection.classList.add('hidden');
            }
        }

        function updateMonthlySummary(data) {
            let days = data.length;
            let totalHours = 0;
            let lowNutDays = 0;
            let exerciseDays = 0;

            data.forEach(d => {
                totalHours += d.studyHours;
                if (d.nutritionRating < 3) {
                    lowNutDays++;
                }
                if (d.exercise) {
                    exerciseDays++;
                }
            });

            daysTrackedCount.textContent = days;
            totalStudyHours.textContent = totalHours.toFixed(1);
            lowNutritionDays.textContent = lowNutDays;
            
            // Store these for the monthly report
            window.monthlyData = {
                daysTracked: days,
                totalStudyHours: totalHours,
                lowNutritionDays: lowNutDays,
                exerciseDays: exerciseDays,
                exerciseGoalDays: 30, // Total possible
                exerciseThreshold: 26, // 30 - 4
                studyGoalHours: 60,
                nutritionTolerance: 5, // Max days allowed with low rating
            };
        }

        // --- Daily Report Logic ---
        function displayDailyReport(data) {
            dailyReportSection.classList.remove('hidden');

            const isEx = data.exercise;
            const isStudy = data.studyHours >= 2;
            const isNutrition = data.nutritionRating >= 3;

            // Check if all goals are met
            const allMet = isEx && isStudy && isNutrition;

            let message = '';
            let bgColor = '';
            let textColor = '';

            if (allMet) {
                bgColor = 'bg-success-green/10 border-success-green/50';
                textColor = 'text-success-green';
                message = `
                    <p class="text-2xl font-extrabold mb-2">${isEx ? 'üåü' : ''} ‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§®, Zala Manish! ${isStudy ? 'üß†' : ''}</p>
                    <p class="text-lg font-medium">‡§Ü‡§™‡§®‡•á ‡§Ü‡§ú ‡§∏‡§≠‡•Ä ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§ø‡§Ø‡§æ! ‡§á‡§∏‡•Ä ‡§ó‡§§‡§ø ‡§ï‡•ã ‡§¨‡§®‡§æ‡§è ‡§∞‡§ñ‡•á‡§Ç!</p>
                `;
            } else {
                bgColor = 'bg-alert-red/10 border-alert-red/50';
                textColor = 'text-alert-red';
                let failures = [];
                if (!isEx) failures.push('Exercise');
                if (!isStudy) failures.push('2 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•Ä ‡§™‡§¢‡§º‡§æ‡§à');
                if (!isNutrition) failures.push('‡§™‡•ã‡§∑‡§£ ‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ñ‡§æ‡§®-‡§™‡§æ‡§® (3+ ‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó)');

                message = `
                    <p class="text-2xl font-extrabold mb-2">üõë Zala Manish, ‡§Ø‡§π ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§π‡•à!</p>
                    <p class="text-lg font-medium">‡§Ü‡§ú ‡§Ü‡§™‡§®‡•á ${failures.join(', ')} ‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ï‡•ã ‡§™‡•Ç‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ‡•§ ‡§è‡§ï ‡§¨‡•á‡§π‡§§‡§∞ ‡§ï‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§ú ‡§π‡•Ä ‡§∏‡•Å‡§ß‡§∞‡•á‡§Ç!</p>
                `;
            }

            dailyReportContent.className = `p-4 rounded-xl text-center transition duration-300 transform hover:scale-[1.01] ${bgColor} ${textColor}`;
            dailyReportContent.innerHTML = message;

            // Study Hours Bonus/Deficit Message
            if (data.studyHours > 2) {
                const extra = (data.studyHours - 2).toFixed(1);
                studyHoursSummary.textContent = `‡§¨‡§ß‡§æ‡§à! ‡§Ü‡§™‡§®‡•á ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§∏‡•á ${extra} ‡§ò‡§Ç‡§ü‡•á ‡•õ‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§™‡§¢‡§º‡§æ‡§à ‡§ï‡•Ä! üî•`;
                studyHoursSummary.style.color = 'green';
            } else if (data.studyHours < 2) {
                 const deficit = (2 - data.studyHours).toFixed(1);
                 studyHoursSummary.textContent = `‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç: ‡§Ü‡§™ 2 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§∏‡•á ${deficit} ‡§ò‡§Ç‡§ü‡•á ‡§™‡•Ä‡§õ‡•á ‡§π‡•à‡§Ç‡•§ üìò`;
                 studyHoursSummary.style.color = 'red';
            } else {
                 studyHoursSummary.textContent = `‡§Ü‡§™‡§®‡•á ‡§†‡•Ä‡§ï 2 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡§æ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§ø‡§Ø‡§æ‡•§ ‡§∂‡§æ‡§¨‡§æ‡§∂! üëç`;
                 studyHoursSummary.style.color = 'green';
            }
        }

        // --- Data Save Function ---
        async function saveDay() {
            if (!isAuthReady || !userId) {
                displayError("Authentication error. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
                return;
            }

            const todayStr = getTodayDateString();
            const studyHours = parseFloat(studyHoursInput.value) || 0;
            const nutritionRating = parseInt(nutritionRatingContainer.querySelector('.selected')?.dataset.rating) || 0;

            if (nutritionRating === 0) {
                 displayError("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ã‡§∑‡§£ ‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó (Nutrition Rating) ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
                 return;
            }

            saveDayBtn.disabled = true;
            saveStatus.textContent = '‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...';
            saveStatus.style.color = 'blue';

            const dailyData = {
                date: todayStr,
                exercise: exerciseCheck.checked,
                studyHours: studyHours,
                nutritionRating: nutritionRating,
                timestamp: Date.now()
            };

            try {
                const docRef = doc(db, getCollectionPath(userId), todayStr);
                await setDoc(docRef, dailyData);

                // onSnapshot will handle the status update
            } catch (error) {
                console.error("Error saving document:", error);
                displayError("‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            } finally {
                saveDayBtn.disabled = false;
            }
        }

        // --- Monthly Report Generation (LLM API Call) ---
        async function generateMonthlyReport() {
            if (!window.monthlyData) {
                displayError("‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§¶‡§ø‡§® ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§");
                return;
            }

            reportBtnText.textContent = '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...';
            reportSpinner.classList.remove('hidden');
            generateMonthlyReportBtn.disabled = true;
            monthlyReportContent.classList.add('hidden');
            
            const data = window.monthlyData;
            
            // Construct detailed query for LLM
            const userQuery = `Zala Manish, ‡§Ü‡§™‡§ï‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§Ç‡§∏ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç‡•§
            - ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§ø‡§è ‡§ó‡§è ‡§¶‡§ø‡§®: ${data.daysTracked}
            - Exercise: ${data.exerciseDays} ‡§¶‡§ø‡§® (‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø: 30, ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§™‡§æ‡§∏: 26)
            - Study Hours: ${data.totalStudyHours.toFixed(1)} ‡§ò‡§Ç‡§ü‡•á (‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø: 60 ‡§ò‡§Ç‡§ü‡•á)
            - Nutrition: ${data.lowNutritionDays} ‡§¶‡§ø‡§® (‡§ï‡§Æ ‡§™‡•ã‡§∑‡§£ ‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó < 3) (‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§∏‡§π‡§ø‡§∑‡•ç‡§£‡•Å‡§§‡§æ: 5 ‡§¶‡§ø‡§®)
            
            ‡§è‡§ï ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§î‡§∞ ‡§™‡•ç‡§∞‡•á‡§∞‡§ï ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (Improvement Report) ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ö‡§™‡§®‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç:
            1. ‡§è‡§ï ‡§™‡•ç‡§∞‡•á‡§∞‡§ï ‡§™‡§∞‡§ø‡§ö‡§Ø ‡§¶‡•á‡§Ç‡•§
            2. ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ (Exercise, Study, Nutrition) ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§
            3. ‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§™‡•Ç‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à (‡§ú‡•à‡§∏‡•á Exercise < 26 ‡§¶‡§ø‡§®, Study < 60 ‡§ò‡§Ç‡§ü‡•á, Low Nutrition > 5 ‡§¶‡§ø‡§®), ‡§§‡•ã 'Zala Manish' ‡§ï‡•ã ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∏‡§≤‡§æ‡§π ‡§¶‡•á‡§Ç‡•§
            4. ‡§Ø‡§¶‡§ø ‡§∏‡•ç‡§ü‡§°‡•Ä ‡§ï‡§æ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø (60 ‡§ò‡§Ç‡§ü‡•á) ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™‡§®‡•á ‡§ú‡§ø‡§§‡§®‡•á ‡§ò‡§Ç‡§ü‡•á ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§™‡§¢‡§º‡§æ‡§à ‡§ï‡•Ä ‡§π‡•à, ‡§â‡§∏‡§ï‡•á ‡§≤‡§ø‡§è 'Zala Manish' ‡§ï‡•ã ‡§è‡§ï ‡§â‡§§‡•ç‡§∏‡§æ‡§π‡§µ‡§∞‡•ç‡§ß‡§ï ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§¶‡•á‡§Ç‡•§
            `;

            const systemPrompt = "‡§Ü‡§™ ‡§è‡§ï ‡§Ö‡§§‡•ç‡§Ø‡§Ç‡§§ ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§î‡§∞ ‡§™‡•ç‡§∞‡•á‡§∞‡§ï ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ï‡•ã‡§ö ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™‡§ï‡•ã ‡§¶‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á 'Zala Manish' ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§, ‡§∏‡§Ç‡§∞‡§ö‡§ø‡§§ ‡§î‡§∞ ‡§™‡•ç‡§∞‡•á‡§∞‡§ï ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§®‡•Ä ‡§π‡•à‡•§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§π‡§Æ‡•á‡§∂‡§æ 'Zala Manish' ‡§ï‡•ã ‡§∏‡§Ç‡§¨‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ï‡•á ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§î‡§∞ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§â‡§§‡•ç‡§§‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§æ ‡§™‡§æ‡§† ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§ï‡•ã‡§à Markdown ‡§π‡•á‡§°‡§ø‡§Ç‡§ó ‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç‡•§";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // Gemini API Call with Backoff (similar to getMovieRecommendation structure)
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const maxRetries = 5;
            let attempt = 0;
            let response = null;

            while (attempt < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break;
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempt++;
                    } else {
                        throw new Error(`API returned status code ${response.status}`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    reportText.innerHTML = `<p class="text-red-600 font-bold">‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä‡•§</p>`;
                    break;
                }
            }
            
            if (!response || !response.ok) {
                reportText.innerHTML = `<p class="text-red-600 font-bold">‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</p>`;
            } else {
                 const result = await response.json();
                 const candidate = result.candidates?.[0];

                 if (candidate && candidate.content?.parts?.[0]?.text) {
                     const text = candidate.content.parts[0].text;
                     
                     // Format the text output into paragraphs for better reading
                     const formattedText = text.split('\n').map(p => {
                        if (p.trim() === '') return '';
                        return `<p>${p.trim()}</p>`;
                     }).join('');

                     reportText.innerHTML = formattedText;
                     monthlyReportContent.classList.remove('hidden');

                     // Extract and display sources (optional for this context but kept for completeness)
                     const groundingMetadata = candidate.groundingMetadata;
                     if (groundingMetadata && groundingMetadata.groundingAttributions) {
                         const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                            .filter(source => source.uri && source.title);
                         
                         if(sources.length > 0) {
                             reportSources.classList.remove('hidden');
                             reportSourceList.innerHTML = sources.map(source => `
                                 <li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 underline">${source.title || source.uri}</a></li>
                             `).join('');
                         }
                     }
                 } else {
                     reportText.innerHTML = `<p class="text-red-600 font-bold">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡•§</p>`;
                 }
            }


            reportBtnText.textContent = '‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç';
            reportSpinner.classList.add('hidden');
            generateMonthlyReportBtn.disabled = false;
        }

        // --- Event Listeners and Helpers ---
        function displayError(message) {
            saveStatus.textContent = `Error: ${message}`;
            saveStatus.style.color = 'red';
        }

        // Rating button handler
        nutritionRatingContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('rating-btn')) {
                const rating = event.target.dataset.rating;
                updateRatingButtons(rating);
            }
        });

        function updateRatingButtons(selectedRating) {
            nutritionRatingContainer.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected', 'ring-4', 'ring-offset-2', 'ring-primary-blue');
                if (btn.dataset.rating === String(selectedRating)) {
                    btn.classList.add('selected', 'ring-4', 'ring-offset-2', 'ring-primary-blue/50');
                }
            });
        }

        saveDayBtn.addEventListener('click', saveDay);
        generateMonthlyReportBtn.addEventListener('click', generateMonthlyReport);

    </script>

</body>
</html>